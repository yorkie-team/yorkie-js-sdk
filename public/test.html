<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Test Example</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.css"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.js"></script>
  </head>
  <body>
    <div>
      <div>status: <span id="network-status"></span></div>
      <textarea id="placeholder" cols="30" rows="10"></textarea>
      <div>peers:</div>
      <pre style="white-space: pre-wrap"><code id="peers-holder"></code></pre>
      <div>document:</div>
      <pre style="white-space: pre-wrap"><code id="log-holder"></code></pre>
      <button id="attach-button">attach doc1</button>
      <button id="attach-button2">attach doc2</button>
    </div>
    <script src="./yorkie.js"></script>
    <script src="./util.js"></script>
    <script>
      const colors = ['#FECEEA', '#FEF1D2', '#A9FDD8', '#D7F8FF', '#CEC5FA'];
      let nextColorIdx = 0;

      const statusHolder = document.getElementById('network-status');
      const placeholder = document.getElementById('placeholder');
      const peersHolder = document.getElementById('peers-holder');
      const logHolder = document.getElementById('log-holder');
      const attachButton = document.getElementById('attach-button');
      const attachButton2 = document.getElementById('attach-button2');
      const selectionMap = new Map();

      function displayLog(doc) {
        logHolder.innerText = doc.toJSON();
      }

      function displayPeers(peers, clientID) {
        const clientIDs = [];

        for (const [clientID, _] of Object.entries(peers)) {
          clientIDs.push(clientID);
        }

        peersHolder.innerHTML = JSON.stringify(clientIDs).replace(
          clientID,
          `<b>${clientID}</b>`,
        );
      }

      async function main() {
        try {
          // 01. create client with RPCAddr(envoy) then activate it.
          const client = new yorkie.Client('http://localhost:8080');
          client.subscribe(network.statusListener(statusHolder));
          await client.activate();

          // 01-2. subscribe client event.
          client.subscribe((event) => {
            displayLog(doc);
            if (event.type === 'peers-changed') {
              displayPeers(event.value[doc.getKey()], client.getID());
            }
          });

          // 02. create a document then attach it into the client.
          const doc = new yorkie.Document('attach-test1');
          const doc2 = new yorkie.Document('attach-test2');
          attachButton.addEventListener('click', async () => {
            await client.attach(doc);
          });
          attachButton2.addEventListener('click', async () => {
            await client.attach(doc2);
          });

          doc.update((root) => {
            if (!root.content) {
              root.content = [1, 2, 3];
            }
          }, 'create content if not exists');
          doc2.update((root) => {
            if (!root.content) {
              root.content = [1, 2, 3];
            }
          }, 'create content if not exists');

          // 02-2. subscribe document event.
          doc.subscribe((event) => {
            console.log('doc event', event);
            displayLog(doc);
          });

          displayLog(doc);
        } catch (e) {
          console.error(e);
        }
      }

      main();
    </script>
  </body>
</html>
